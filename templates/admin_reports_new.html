{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar text-primary"></i> Progress Reports</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download"></i> Export Reports
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportData('csv')">
                            <i class="fas fa-file-csv text-success"></i> Export as CSV</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('excel')">
                            <i class="fas fa-file-excel text-success"></i> Export as Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">
                            <i class="fas fa-file-pdf text-danger"></i> Export as PDF</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportData('word')">
                            <i class="fas fa-file-word text-primary"></i> Export as Word</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Filter Reports</h5>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="GET">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="month" class="form-label">Month</label>
                                <select class="form-select" id="month" name="month">
                                    <option value="">All Months</option>
                                    {% for period in months_years %}
                                        <option value="{{ period.month }}" 
                                                {% if request.args.get('month') == period.month %}selected{% endif %}>
                                            {{ period.month }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="year" class="form-label">Year</label>
                                <select class="form-select" id="year" name="year">
                                    <option value="">All Years</option>
                                    {% for period in months_years %}
                                        <option value="{{ period.year }}" 
                                                {% if request.args.get('year') == period.year|string %}selected{% endif %}>
                                            {{ period.year }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="employee" class="form-label">Employee</label>
                                <select class="form-select" id="employee" name="employee">
                                    <option value="">All Employees</option>
                                    {% for emp in employees %}
                                        <option value="{{ emp.emp_id }}" 
                                                {% if request.args.get('employee') == emp.emp_id %}selected{% endif %}>
                                            {{ emp.first_name }} {{ emp.last_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="project" class="form-label">Project</label>
                                <select class="form-select" id="project" name="project">
                                    <option value="">All Projects</option>
                                    {% for proj in projects %}
                                        <option value="{{ proj.proj_id }}" 
                                                {% if request.args.get('project') == proj.proj_id %}selected{% endif %}>
                                            {{ proj.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <a href="{{ url_for('admin_reports') }}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Clear Filters
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ total_entries }}</h4>
                                    <p class="mb-0">Total Entries</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ total_employees }}</h4>
                                    <p class="mb-0">Employees</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ total_projects }}</h4>
                                    <p class="mb-0">Projects</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-project-diagram fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ "%.1f"|format(avg_percentage) }}%</h4>
                                    <p class="mb-0">Avg Percentage</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-percentage fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Work Progress Data</h5>
                    <div>
                        <span class="badge bg-primary">{{ reports|length }} records</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if reports and reports|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th>Project</th>
                                        <th>Client</th>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Percentage</th>
                                        <th>Submitted</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for report in reports %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar bg-primary text-white rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                    {{ report.first_name[0] }}{{ report.last_name[0] if report.last_name else '' }}
                                                </div>
                                                <div>
                                                    <strong>{{ report.first_name }} {{ report.last_name }}</strong><br>
                                                    <small class="text-muted">{{ report.email }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ report.department }}</span>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ report.project_name }}</strong><br>
                                                <small class="text-muted">{{ report.proj_id }}</small>
                                            </div>
                                        </td>
                                        <td>{{ report.client }}</td>
                                        <td>{{ report.month }}</td>
                                        <td>{{ report.year }}</td>
                                        <td>
                                            <div class="progress" style="height: 20px;">
                                                <div class="progress-bar
                                                    {% if report.percentage >= 80 %}bg-success
                                                    {% elif report.percentage >= 50 %}bg-warning
                                                    {% else %}bg-danger{% endif %}" 
                                                    style="width: {{ report.percentage }}%">
                                                    {{ report.percentage }}%
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ report.submission_date }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Progress Data Available</h4>
                            <p class="text-muted">No work progress data found for the selected criteria.</p>
                            <div class="mt-4">
                                <a href="{{ url_for('admin_employees') }}" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-users"></i> Manage Employees
                                </a>
                                <a href="{{ url_for('admin_projects') }}" class="btn btn-outline-info me-2">
                                    <i class="fas fa-project-diagram"></i> Manage Projects
                                </a>
                                <a href="{{ url_for('admin_database') }}" class="btn btn-outline-warning">
                                    <i class="fas fa-database"></i> Add Sample Data
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Export functionality
function exportData(format) {
    const params = new URLSearchParams(window.location.search);
    const exportUrl = `{{ url_for('admin_reports') }}/export_${format}?${params.toString()}`;
    window.open(exportUrl, '_blank');
}
</script>
{% endblock %}